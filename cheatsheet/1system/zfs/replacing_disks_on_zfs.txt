2 программном raid на ZFS (утилита zpool))

На TheBox файловая система ZFS все операции с ней проводятся утилитами zpool и zfs.
Полезные команды:

    camcontrol devlist "список дисков"
    gpart show "cписок разделов"
    zpool status -x "показать информацию о состоянии всех пулов"
    zpool status -v pool_name "показать информацию о состоянии конкретного пула в расширенном виде"

Алгоритм замены диска

# вывести список пулов и определить вышедший из строя диск
zpool list
zpool status -v pool_name

#перевести сломанный диск в оффлайн, при этом все операции с ним прекратятся 
zpool offline -t pool_name bad_disk_name
Если получена ошибка "no such device in pool", выясняем id диска с помощью утилиты zdb и переводим диск в оффлайн по id, а не по имени

#заменить диск физически (самый простой способ найти диск этозапустить операцию чтения/записи. Диск в оффлайне мигать не будет)

#определить id (19 символов) присвоенный старому диску
zpool status -v pool_name

---------------------------------------------------------------------------------
#Далее если диск загрузочный:
#Клонирование таблицы разделов и установка загрузчик
gpart backup worked_disk > part_table.gpt
gpart restore -F new_clean_disk < part_table.gpt
gpart show
gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 new_clean_disk

#Подключить новый раздел к zfs
zpool replace pool_name id partiton_for_system_on_new_disk
---------------------------------------------------------------------------------
#Далее если диск не загрузочный:

#Подключить новый диск к zfs
zpool replace pool_name id new_disk_name
---------------------------------------------------------------------------------
#Далее для любых дисков:

#после окончания перестроения очистить ошибки в пуле
zpool clear pool_name

#запустить процесс проверки данных и метаданных (советуют, но не обязательно)
zpool scrub pool_name
