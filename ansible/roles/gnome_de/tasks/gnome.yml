#-----------------------------------------------------------------------------------------------
# GNOME
- name: gnome packages
  yum:
    state: latest
    name:
      - "@base-x"
      - gnome-session-xsession
      - control-center
      - krb5-libs
      - gnome-tweak-tool
      - dconf-editor
      - python3-psutil
      - dbus-x11
      - dnsmasq
  become: true

- name: gnome gdm wayland disable
  lineinfile:
    path: /etc/gdm/custom.conf
    regexp: 'WaylandEnable='
    line: WaylandEnable=false
  become: true

- name: gnome systemd target 1
  command: systemctl get-default
  register: contents
  changed_when: false

- name: gnome systemd target 2
  command: systemctl set-default graphical.target
  when: contents.stdout != "graphical.target"
  become: true
#-----------------------------------------------------------------------------------------------
# GNOME EXTENSIONS

#- name: gnome extension drop-down terminal
#  import_role:
#    name: jaredhocutt.gnome_extensions
#  vars:
#    gnome_extension_ids:
#      - 3780
#
#- name: gnome extension drop-down terminal 2
#  dconf:
#    key: "{{ item.key }}"
#    value: "{{ item.value |string }}"
#  loop:
#    - { key: "/com/github/amezin/ddterm/custom-font", value: "'Bitstream Vera Sans Mono 14'" }
#    - { key: "/com/github/amezin/ddterm/ddterm-toggle-hotkey", value: "['<Control>grave']" }
#    - { key: "/com/github/amezin/ddterm/detect-urls-news-man", value: "false" }
#    - { key: "/com/github/amezin/ddterm/detect-urls-voip", value: "false" }
#    - { key: "/com/github/amezin/ddterm/notebook-border", value: "false" }
#    - { key: "/com/github/amezin/ddterm/override-window-animation", value: "false" }
#    - { key: "/com/github/amezin/ddterm/scroll-on-keystroke", value: "false" }
#    - { key: "/com/github/amezin/ddterm/scrollback-unlimited", value: "true" }
#    - { key: "/com/github/amezin/ddterm/tab-policy", value: "'automatic'" }
#    - { key: "/com/github/amezin/ddterm/theme-variant", value: "'dark'" }
#    - { key: "/com/github/amezin/ddterm/use-system-font", value: "false" }
#    - { key: "/com/github/amezin/ddterm/use-theme-colors", value: "true" }
#    - { key: "/com/github/amezin/ddterm/window-maximize", value: "false" }
#    - { key: "/com/github/amezin/ddterm/window-size", value: "1.0" }

- name: gnome extension gnome desktop icons 1
  import_role:
    name: jaredhocutt.gnome_extensions
  vars:
    gnome_extension_ids:
      - 2087

- name: extension gnome quake-mode 1
  import_role:
    name: jaredhocutt.gnome_extensions
  vars:
    gnome_extension_ids:
      - 1411

- name: extension gnome quake-mode 2
  dconf:
    key: "{{ item.key }}"
    value: "{{ item.value |string }}"
  loop:
    - { key: "/com/github/repsac-by/quake-mode/quake-mode-tray", value: "true" }
    - { key: "/com/github/repsac-by/quake-mode/quake-mode-width", value: "100" }
    - { key: "/com/github/repsac-by/quake-mode/quake-mode-height", value: "100" }
    - { key: "/com/github/repsac-by/quake-mode/quake-mode-animation-time", value: "0.25" }
    - { key: "/com/github/repsac-by/quake-mode/quake-mode-hide-from-overview", value: "true" }
    - { key: "/com/github/repsac-by/quake-mode/quake-mode-hotkey", value: "['<Primary>grave']" }
    - { key: "/com/github/repsac-by/quake-mode/quake-mode-app", value: "'org.gnome.Terminal.desktop'" }

- name: gnome extension gnome unite 1
  yum: name=xprop state=latest
  become: true

- name: gnome extension gnome unite 2
  import_role:
    name: jaredhocutt.gnome_extensions
  vars:
    gnome_extension_ids:
      - 1287

- name: gnome extension gnome unite 3
  dconf:
    key: "{{ item.key }}"
    value: "{{ item.value |string }}"
  loop:
    - { key: "/org/gnome/shell/extensions/unite/extend-left-box", value: "false" }
    - { key: "/org/gnome/shell/extensions/unite/show-desktop-name", value: "false" }
    - { key: "/org/gnome/shell/extensions/unite/hide-app-menu-icon", value: "true" }
    - { key: "/org/gnome/shell/extensions/unite/hide-app-menu-arrow", value: "true" }
    - { key: "/org/gnome/shell/extensions/unite/show-window-title", value: "'never'" }
    - { key: "/org/gnome/shell/extensions/unite/greyscale-tray-icons", value: "true" }
    - { key: "/org/gnome/shell/extensions/unite/show-window-buttons", value: "'never'" }
    - { key: "/org/gnome/shell/extensions/unite/hide-window-titlebars", value: "'never'" }
    - { key: "/org/gnome/shell/extensions/unite/hide-aggregate-menu-arrow", value: "true" }
    - { key: "/org/gnome/shell/extensions/unite/hide-activities-button", value: "'never'" }
    - { key: "/org/gnome/shell/extensions/unite/window-buttons-placement", value: "'last'" }
    - { key: "/org/gnome/shell/extensions/unite/window-buttons-theme", value: "'united-dark'" }

- name: gnome extension gnome workspace 1
  import_role:
    name: jaredhocutt.gnome_extensions
  vars:
    gnome_extension_ids:
      - 21

- name: gnome extension gnome workspace 2
  dconf:
    key: "{{ item.key }}"
    value: "{{ item.value |string }}"
  loop:
    - { key: "/org/gnome/mutter/dynamic-workspaces", value: "false" }
    - { key: "/org/gnome/mutter/workspaces-only-on-primary", value: "false" }
    - { key: "/org/gnome/shell/overrides/dynamic-workspaces", value: "false" }
    - { key: "/org/gnome/shell/overrides/workspaces-only-on-primary", value: "false" }
    - { key: "/org/gnome/shell/app-switcher/current-workspace-only", value: "true" }

- name: gnome extension no-overview
  import_role:
    name: jaredhocutt.gnome_extensions
  vars:
    gnome_extension_ids:
      - 4099

# FYI https://discourse.gnome.org/t/enable-gnome-extensions-without-session-restart/7936
- block:
    - name: gnome restart GUI 1
      blockinfile:
        dest: /etc/gdm/custom.conf
        marker: "#<!-- {mark} ANSIBLE MANAGED BLOCK gnome autologin -->"
        insertafter: "\\[daemon\\]"
        block: |
          AutomaticLoginEnable=True
          AutomaticLogin={{ ansible_user_id }}
      register: autologin_state
    
    - name: gnome restart GUI 2
      service: name=gdm state=restarted
      notify:
        - session_logout
    
    - name: gnome restart GUI 3
      pause:
        seconds: 15
    
    - name: gnome restart GUI 4
      blockinfile:
        dest: /etc/gdm/custom.conf
        marker: "#<!-- {mark} ANSIBLE MANAGED BLOCK gnome autologin -->"
        state: absent
      when: autologin_state.changed

  become: true

- include_tasks: "gnome_enable_extension.yml"
  loop:
    - no-overview@fthx
    - ding@rastersoft.com
    - quake-mode@repsac-by.github.com
    - unite@hardpixel.eu
    - workspace-indicator@gnome-shell-extensions.gcampax.github.com
  loop_control:
    loop_var: extension_name

- name: gnome flatpak 1
  yum: name=flatpak state=latest
  become: true

- name: gnome flatpak 2
  community.general.flatpak_remote:
    name: flathub
    state: present
    flatpakrepo_url: https://flathub.org/repo/flathub.flatpakrepo
  become: true

#https://askubuntu.com/questions/1403931/how-to-apply-system-theme-to-flatpak-apps-that-use-gtk4
- name: gnome flatpak 3
  community.general.flatpak:
    name: org.gtk.Gtk3theme.Adwaita-dark
    state: present
  become: true

- name: gnome flatpak 4
  command: flatpak override --env GTK_THEME=Adwaita-dark
  become: true

- name: gnome extension manager 3
  community.general.flatpak:
    name: org.gnome.Extensions
    state: present
  become: true

#-----------------------------------------------------------------------------------------------
# GNOME VNC
- name: gnome vnc 1
  dconf:
    key: "{{ item.key }}"
    value: "{{ item.value |string }}"
  loop:
    - { key: "/org/gnome/desktop/remote-desktop/vnc/encryption", value: "['none']" }
    
#-----------------------------------------------------------------------------------------------
# GNOME APPEARANCE

- name: gnome color theme 1
  dconf: key="/org/gnome/desktop/interface/color-scheme" value="'prefer-dark'"

- name: gnome color theme 2
  dconf: key="/org/gnome/desktop/interface/gtk-theme" value="'Adwaita-dark'"

- block:
    - name: gnome cursor theme 1
      yum: name=dmz-cursor-themes state=latest
      become: true
    
    - name: gnome cursor theme 2
      dconf: key="/org/gnome/desktop/interface/cursor-theme" value="'DMZ-White'"

    - name: gnome icon theme 1
      yum: name=gnome-icon-theme state=latest
      become: true
    
    - name: gnome icon theme 2
      dconf: key="/org/gnome/desktop/interface/icon-theme" value="'gnome'"

  when: ansible_distribution == "Fedora"

- name: gnome fonts 1
  file:
    path: ~/.local/share/fonts/
    state: directory

- name: gnome fonts 2
  unarchive:
    src: https://ftp.gnome.org/pub/GNOME/sources/ttf-bitstream-vera/1.10/ttf-bitstream-vera-1.10.zip
    dest: ~/.local/share/fonts/
    remote_src: yes
    creates: ~/.local/share/fonts/ttf-bitstream-vera-1.10/
  register: fonts_state

- name: gnome fonts 3
  unarchive:
    src: https://assets.ubuntu.com/v1/0cef8205-ubuntu-font-family-0.83.zip
    dest: ~/.local/share/fonts/
    remote_src: yes
    creates: ~/.local/share/fonts/ubuntu-font-family-0.83/
  register: fonts_state

- name: gnome fonts 3
  command: fc-cache -f ~/.local/share/fonts/
  when: fonts_state.changed

- name: gnome fonts 4
  dconf:
    key: "{{ item.key }}"
    value: "{{ item.value |string }}"
  loop:
    - { key: "/org/gnome/desktop/interface/monospace-font-name", value: "'Ubuntu Mono 11'" }
    - { key: "/org/gnome/desktop/interface/document-font-name", value: "'Ubuntu Italic 11'" }
    - { key: "/org/gnome/desktop/interface/font-name", value: "'Ubuntu 11'" }
    - { key: "/org/gnome/desktop/wm/preferences/titlebar-uses-system-font", value: "true" }
    - { key: "/org/gnome/desktop/wm/preferences/titlebar-font", value: "'Ubuntu Medium 11'" }
    - { key: "/org/gnome/desktop/interface/font-antialiasing", value: "'rgba'" }

- name: gnome background and screensaver
  dconf:
    key: "{{ item.key }}"
    value: "{{ item.value |string }}"
  loop:
    - { key: "/org/gnome/desktop/background/primary-color", value: "'#2e3436'" }
    - { key: "/org/gnome/desktop/background/picture-options", value: "'wallpaper'" }
    - { key: "/org/gnome/desktop/screensaver/primary-color", value: "'#2e3436'" }
    - { key: "/org/gnome/desktop/screensaver/picture-options", value: "'wallpaper'" }

- name: gnome nightlight
  dconf: key="/org/gnome/settings-daemon/plugins/color/night-light-enabled" value="true"

- name: gnome button-layout
  dconf: key="/org/gnome/desktop/wm/preferences/button-layout" value="'appmenu:minimize,maximize,close'"

- name: gnome clock
  dconf: key="/org/gnome/desktop/interface/clock-show-weekday" value="true"

- name: gnome battery
  dconf: key="/org/gnome/desktop/interface/show-battery-percentage" value="true"

- name: gnome wm hotkeys
  dconf:
    key: "{{ item.key }}"
    value: "{{ item.value |string }}"
  loop:
    - { key: "/org/gnome/desktop/wm/keybindings/close", value: "['<Super>q']" }
    - { key: "/org/gnome/desktop/wm/keybindings/show-desktop", value: "['<Super>d']" }
    - { key: "/org/gnome/desktop/wm/keybindings/switch-applications", value: "@as []" }
    - { key: "/org/gnome/desktop/wm/keybindings/switch-applications-backward", value: "@as []" }
    - { key: "/org/gnome/desktop/wm/keybindings/switch-windows", value: "['<Alt>Tab']" }
    - { key: "/org/gnome/desktop/wm/keybindings/switch-to-workspace-1", value: "['<Primary>1']" }
    - { key: "/org/gnome/desktop/wm/keybindings/switch-to-workspace-2", value: "['<Primary>2']" }
    - { key: "/org/gnome/desktop/wm/keybindings/switch-to-workspace-3", value: "['<Primary>3']" }
    - { key: "/org/gnome/desktop/wm/keybindings/switch-to-workspace-4", value: "['<Primary>4']" }
    - { key: "/org/gnome/desktop/wm/keybindings/move-to-workspace-1", value: "['<Primary><Shift>exclam']" }
    - { key: "/org/gnome/desktop/wm/keybindings/move-to-workspace-2", value: "['<Primary><Shift>at']" }
    - { key: "/org/gnome/desktop/wm/keybindings/move-to-workspace-3", value: "['<Primary><Shift>numbersign']" }
    - { key: "/org/gnome/desktop/wm/keybindings/move-to-workspace-4", value: "['<Primary><Shift>dollar']" }

- block:
    - name: gnome lock&sleep
      dconf:
        key: "{{ item.key }}"
        value: "{{ item.value |string }}"
      loop:
        - { key: "/org/gnome/desktop/lockdown/disable-lock-screen", value: "true" }
        - { key: "/org/gnome/desktop/screensaver/lock-enabled", value: "false" }
        - { key: "/org/gnome/desktop/session/idle-delay", value: "uint32 0" }
        - { key: "/org/gnome/settings-daemon/plugins/power/sleep-inactive-ac-type", value: "'nothing'" }
        - { key: "/org/gnome/desktop/notifications/show-in-lock-screen", value: "false" }
    
    - name: gnome monitors
      copy: src=monitors.xml dest=~/.config/

    - name: gnome autologin
      blockinfile:
        dest: /etc/gdm/custom.conf
        marker: "#<!-- {mark} ANSIBLE MANAGED BLOCK gnome autologin -->"
        insertafter: "\\[daemon\\]"
        block: |
          AutomaticLoginEnable=True
          AutomaticLogin={{ ansible_user_id }}
      become: true

  when: ansible_virtualization_role == "guest"
