10 15 * * mon root bash -c "/usr/local/bin/backup.sh | tee >(systemd-cat -t backup)"

#!/bin/bash
set -e
PASS=password
DATE=$(date -I)
LDEV="/dev/disk/by-id/ata-WDC_WD5000AZRX-00A8LB0_WD-WCC1U4352895-part3"

#----------------------------------------------------------------------------------------------------------
trap 'cd /; \
lvremove -A y -qq -f /dev/my_machine/backup || true; \
umount ${LDEV}' EXIT

mount ${LDEV} /mnt/backup_hdd
cd /mnt/backup_hdd/my_machine_backup/

#----------------------------------------------------------------------------------------------------------
par2verify -qq latest/*.7z.par2
par2verify -qq latest/*.fsa.par2

lvcreate -s -qq -n backup -L4G /dev/my_machine/root
rm -rf previous/ && mkdir incomplete/

#----------------------------------------------------------------------------------------------------------
7za a -ssc -p$PASS incomplete/data-backup-$DATE.7z \
/home/username/.config/keepassxc/ \
/home/username/.mozilla/ \
/home/username/.ssh/ >> /dev/null
fsarchiver -A -Z 15 -j 4 -c $PASS \
savefs incomplete/system-backup-$DATE.fsa \
/dev/disk/by-id/ata-PLEXTOR_PX-256M5M_P02310105851-part1 \
/dev/my_machine/backup >> /dev/null 2>&1 

#----------------------------------------------------------------------------------------------------------
par2create -r100 -n1 -t4 -T4 incomplete/system-backup-$DATE.fsa >> /dev/null
par2create -r100 -n1 -t4 -T4 incomplete/data-backup-$DATE.7z >> /dev/null

#----------------------------------------------------------------------------------------------------------
mv latest/ previous
mv incomplete/ latest

#----------------------------------------------------------------------------------------------------------
ssh -T -i ~/.ssh/id_rsa_backup backup@somesshserver << 'EOF' 
cd /stor/backup/my_machine && \
rm -rf previous/ && \
mkdir transfer/
EOF
scp -q -i /root/.ssh/id_rsa_backup -r latest/*.7z latest/*.fsa backup@somesshserver:/stor/backup/my_machine/transfer
ssh -T -i ~/.ssh/id_rsa_backup backup@somesshserver << 'EOF'
cd /stor/backup/my_machine && \
mv latest/ previous && \
mv transfer/ latest
EOF
